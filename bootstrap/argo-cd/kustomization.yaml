apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: argocd
resources:
- github.com/argoproj-labs/argocd-autopilot/manifests/base?ref=v0.4.20

patches:
  # 1) Enable Kustomize exec plugins
  - target:
      version: v1
      kind: ConfigMap
      name: argocd-cm
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: argocd-cm
      data:
        kustomize.buildOptions: "--enable-alpha-plugins --enable-exec"

  # 2) Install + wire KSOPS and mount the age key
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: argocd-repo-server
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: argocd-repo-server
      spec:
        template:
          spec:
            volumes:
              - name: custom-tools
                emptyDir: {}
              - name: sops-age
                secret:
                  secretName: sops-age
            initContainers:
              - name: install-ksops
                image: alpine:3.20
                command: ["/bin/sh", "-c"]
                args:
                  - |
                    set -eux
                    apk add --no-cache ca-certificates curl tar
                    case "$(uname -m)" in
                      x86_64|amd64) ARCH="x86_64" ;;
                      aarch64|arm64) ARCH="arm64" ;;
                      *) echo "unsupported arch: $(uname -m)"; exit 1 ;;
                    esac
                    VERSION="v4.4.0"
                    VERSION_RAW="${VERSION#v}"
                    URL="https://github.com/viaduct-ai/kustomize-sops/releases/download/${VERSION}/ksops_${VERSION_RAW}_Linux_${ARCH}.tar.gz"
                    mkdir -p /plugin
                    curl -fsSL -o /tmp/ksops.tgz "${URL}"
                    tar -C /plugin -xzf /tmp/ksops.tgz ksops
                    chmod +x /plugin/ksops
                volumeMounts:
                  - name: custom-tools
                    mountPath: /plugin
            containers:
              - name: argocd-repo-server
                env:
                  - name: XDG_CONFIG_HOME
                    value: /home/argocd/.config
                  - name: SOPS_AGE_KEY_FILE
                    value: /home/argocd/.config/sops/age/keys.txt
                volumeMounts:
                  # KSOPS plugin must live in the kustomize plugin dir:
                  - name: custom-tools
                    mountPath: /home/argocd/.config/kustomize/plugin/viaduct.ai/v1/ksops
                  # age private key:
                  - name: sops-age
                    mountPath: /home/argocd/.config/sops/age
                    readOnly: true

