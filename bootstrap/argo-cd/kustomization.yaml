apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: argocd
resources:
- github.com/argoproj-labs/argocd-autopilot/manifests/base?ref=v0.4.20

patches:
  # 1) Enable Kustomize exec plugins
  - target:
      version: v1
      kind: ConfigMap
      name: argocd-cm
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: argocd-cm
      data:
        kustomize.buildOptions: "--enable-alpha-plugins --enable-exec"

  # 2) Install + wire KSOPS and mount the age key
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: argocd-repo-server
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: argocd-repo-server
      spec:
        template:
          spec:
            volumes:
              - name: custom-tools
                emptyDir: {}
              - name: sops-age
                secret:
                  secretName: sops-age
            initContainers:
              - name: install-ksops
                image: viaductoss/ksops:v4.4.0
                command: ["/bin/sh", "-c"]
                args:
                  - |
                    echo "Installing KSOPS...";
                    mv ksops /custom-tools/;
                    mv kustomize /custom-tools/;
                    echo "Done.";
                volumeMounts:
                  - name: custom-tools
                    mountPath: /custom-tools
            containers:
              - name: argocd-repo-server
                env:
                  - name: XDG_CONFIG_HOME
                    value: /home/argocd/.config
                  - name: SOPS_AGE_KEY_FILE
                    value: /home/argocd/.config/sops/age/keys.txt
                volumeMounts:
                  - name: custom-tools
                    mountPath: /usr/local/bin/ksops
                    subPath: ksops
                  - name: custom-tools
                    mountPath: /usr/local/bin/kustomize
                    subPath: kustomize
                  - name: sops-age
                    mountPath: /home/argocd/.config/sops/age
                    readOnly: true
